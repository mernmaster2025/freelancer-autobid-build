import{l as e,s as t,S as r,t as n,a as s}from"./constants.js";import{s as a,u as i,a as o,c}from"./supabaseService.js";const l=new class{constructor(){this.lastError=null,this.signedContracts=new Map}isContractSigned(e,t){const r=`${e}_${t}`;return this.signedContracts.has(r)}markContractSigned(e,t){const r=`${e}_${t}`;this.signedContracts.set(r,!0)}extractDataAttribute(e,t){const r=new RegExp(`${t}\\s*=\\s*["']([^"']*)["']`),n=e.match(r);return n?n[1]:null}decodeHtmlEntities(e){return e?e.replace(/&#34;/g,'"'):e}async fetchNDAContract(t){try{const n=`https://www.freelancer.com/ajax/project/contract/initialize-nda-contract.php?project_id=${t}&type=nda`,s=await fetch(n,{headers:{Accept:"text/html"},credentials:"include"});if(!s.ok)throw new Error(`Failed to fetch NDA contract page. Status: ${s.status}`);const a=(await s.text()).match(/<[^>]*data-contract-control-container[^>]*>/s);if(!a)throw new Error("Could not find control container in the NDA contract HTML.");const i=a[0],o=this.extractDataAttribute(i,"data-signing-url"),c=this.extractDataAttribute(i,"data-signing-token"),l=this.extractDataAttribute(i,"data-signing-auth-token"),u=this.extractDataAttribute(i,"data-template-content-fields");let d=[];if(u)try{const e=this.decodeHtmlEntities(u);d=JSON.parse(e)}catch(r){e.warn(`Failed to parse template fields: ${r.message}`),d=[]}if(!o||!c||!l)throw new Error("Failed to parse one or more critical tokens from the NDA contract page.");return{signingUrl:o,signingToken:c,signingAuthToken:l,templateFields:d}}catch(r){throw this.lastError=r,r}}async fetchIPContract(e){try{const t=`https://www.freelancer.com/ajax/project/contract/initialize-freelancer-ip-contract.php?projectId=${e}`,r=await fetch(t,{headers:{Accept:"text/html"},credentials:"include"});if(!r.ok)throw new Error(`Failed to fetch IP Agreement contract page. Status: ${r.status}`);const n=(await r.text()).match(/<[^>]*data-contract-control-container[^>]*>/s);if(!n)throw new Error("Could not find control container in the IP Agreement contract HTML.");const s=n[0],a=this.extractDataAttribute(s,"data-signing-url"),i=this.extractDataAttribute(s,"data-signing-token"),o=this.extractDataAttribute(s,"data-signing-auth-token");if(!a||!i||!o)throw new Error("Failed to parse one or more critical tokens from the IP Agreement contract page.");return{signingUrl:a,signingToken:i,signingAuthToken:o}}catch(t){throw this.lastError=t,t}}async submitNDA(e,t){try{const r=`https://contracts.freelancer.com${e}`,n={full_name:t.fullName,signature_data:t.signatureData,signing_token:t.signingToken};t.templateFields&&Array.isArray(t.templateFields)&&t.templateFields.forEach(e=>{"full_address"===e.name&&(n[e.name]=t.fullAddress)});const s=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json",Authorization:t.signingAuthToken,Origin:"https://www.freelancer.com"},body:JSON.stringify(n)});if(!s.ok){const e=await s.text();throw new Error(`Server returned an error: ${s.status} ${s.statusText}. Response: ${e}`)}const a=await s.json();if("success"!==a.status||"string"!=typeof a.data)throw new Error(a.message||"NDA submission POST was not successful or did not return a verification URL.");return a.data}catch(r){throw this.lastError=r,r}}async submitIPDocument(e,t){try{const r=`https://contracts.freelancer.com${e}`,n={full_name:t.fullName,signature_data:t.signatureData,signing_token:t.signingToken},s=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json",Authorization:t.signingAuthToken,Origin:"https://www.freelancer.com"},body:JSON.stringify(n)});if(!s.ok){const e=await s.text();throw new Error(`Server returned an error: ${s.status} ${s.statusText}. Response: ${e}`)}const a=await s.json();if("success"!==a.status||"string"!=typeof a.data)throw new Error(a.message||"IP Agreement submission POST was not successful or did not return a verification URL.");return a.data}catch(r){throw this.lastError=r,r}}async verifySignature(e){try{const t=await fetch(e,{method:"GET",headers:{Origin:"https://www.freelancer.com"}});if(!t.ok)throw new Error(`Final verification step failed with status: ${t.status}`);return!0}catch(t){throw this.lastError=t,t}}async signNDAContract(t,r){try{if(this.isContractSigned(t,"nda"))return{success:!0,alreadySigned:!0};const n=await this.fetchNDAContract(t),s={...n,fullName:r.fullName,fullAddress:r.fullAddress,signatureData:r.signature},a=await this.submitNDA(n.signingUrl,s);return await this.verifySignature(a),this.markContractSigned(t,"nda"),e.success(`NDA contract signed successfully for project ${t}`),{success:!0}}catch(n){return e.error(`Failed to sign NDA contract for project ${t}: ${n.message}`),{success:!1,error:n.message}}}async signIPContract(t,r){try{if(this.isContractSigned(t,"ip"))return{success:!0,alreadySigned:!0};const n=await this.fetchIPContract(t),s={...n,fullName:r.fullName,signatureData:r.signature},a=await this.submitIPDocument(n.signingUrl,s);return await this.verifySignature(a),this.markContractSigned(t,"ip"),e.success(`IP contract signed successfully for project ${t}`),{success:!0}}catch(n){return e.error(`Failed to sign IP contract for project ${t}: ${n.message}`),{success:!1,error:n.message}}}async signAllRequired(t,r){try{const n=[];let s=!1,a=!1;const i=!0===t.isNDA||!0===t.nda||!0===t.ndaIp,o=!0===t.isIPContract||!0===t.ip||!0===t.ndaIp;if(i){const e=await this.signNDAContract(t.id,r);e.success?s=!0:n.push(`NDA: ${e.error}`)}if(o){const e=await this.signIPContract(t.id,r);e.success?a=!0:n.push(`IP Agreement: ${e.error}`)}return(!i||s)&&(!o||a)?(e.success(`All required contracts signed for project ${t.id}`),{success:!0,ndaSigned:s,ipSigned:a}):(e.error(`Failed to sign all required contracts for project ${t.id}: ${n.join("; ")}`),{success:!1,error:n.join("; "),ndaSigned:s,ipSigned:a})}catch(n){return e.error(`Error signing contracts for project ${t.id}: ${n.message}`),{success:!1,error:n.message}}}validateSignatureData(e){return e?e.signature&&e.signature.startsWith("data:image/png;base64,")?e.fullName&&e.fullName.trim()?e.fullAddress&&e.fullAddress.trim()?{valid:!0}:{valid:!1,error:"Full address is required"}:{valid:!1,error:"Full name is required"}:{valid:!1,error:"Invalid signature format. Must be a PNG data URI."}:{valid:!1,error:"Signature data not found"}}async getSignatureDataFromStorage(){try{const e=await t.get("signature")||{};return e.signature&&e.fullName&&e.fullAddress?e:null}catch(r){return e.error(`Failed to get signature data from storage: ${r.message}`),null}}};let u=null,d=!1;const g=[];let m=null;async function p(){const e=await t.get("bidding")||{},r=(new Date).toDateString(),n=e.dailyBids||{count:0,date:r};return n.date!==r?{count:0,date:r}:n}async function h(){const e=await t.get("bidding")||{},r=(new Date).toDateString(),n={count:(await p()).count+1,date:r};return await t.set("bidding",{...e,dailyBids:n}),n}async function f(e){const t=function(e){switch(e){case"basic":default:return 10;case"premium":return 20;case"ultra":return-1}}(e),r=await p();if(-1===t)return{exceeded:!1,remaining:-1,limit:-1};const n=Math.max(0,t-r.count);return{exceeded:r.count>=t,remaining:n,limit:t}}async function w(r,n){const s=await async function(r,n=[]){const s=(await t.get("template")||{}).templates||[];if(0===s.length)return e.warn("No templates found"),null;const a=(r+" "+n.map(e=>"string"==typeof e?e.toLowerCase():e&&e.name?e.name.toLowerCase():"").filter(e=>e.length>0).join(" ")).toLowerCase();for(const e of s){if(!e.text)continue;if(!(e.keywords&&e.keywords.trim().length>0))continue;const t=i.parseCommaSeparated(e.keywords);if(0!==t.length&&i.containsKeyword(a,t).found)return e}return s[s.length-1]||null}(r.title,n);return s?{matchedProposal:s}:{valid:!1,reason:"Please add at least one proposal"}}async function y(r,n={}){var s;const{skipAutoValidation:a=!1}=n,c=await t.get("filters")||{},u=await t.get("auth")||{},d=null==(s=null==u?void 0:u.profile)?void 0:s.freelancer_auth_token,g=function(e,t,r){if(r)return null;const n=t.projectPostTimeMinutes||0;if(0===n)return null;const s=e.submitdate||e.submit_date||e.time_submitted;if(!s)return null;const a=new Date(1e3*s),i=new Date,o=Math.floor((i-a)/6e4);return o>n?{valid:!1,reason:`Project was posted ${o} minute(s) ago, but minimum required is ${n} minute(s).`}:null}(r,c,a);if(g)return g;const m=function(e,t){const r=!0===e.hourly||"hourly"===e.type,n=!1===e.hourly||"fixed"===e.type,s=e.isRecruiter,a=e.isNDA||e.isIPContract;return!t.hourlyProject&&r?{valid:!1,reason:"Hourly projects are disabled in filters"}:!t.fixedProject&&n?{valid:!1,reason:"Fixed-price projects are disabled in filters"}:!t.recruiterProject&&s?{valid:!1,reason:"Recruiter projects are disabled in filters"}:!t.ndaIpProject&&a?{valid:!1,reason:"NDA/IP projects are disabled in filters"}:null}(r,c);if(m)return m;const p=function(e,t,r){var n,s;if(r)return null;const a=(null==(n=e.bidStats)?void 0:n.bidCount)||(null==(s=e.bid_stats)?void 0:s.bid_count)||e.bid_count||0,i=t.totalBids||0;return i>0&&a>i?{valid:!1,reason:`Project has ${a} bid(s), which exceeds the maximum allowed (${i}).`}:null}(r,c,a);if(p)return p;let h=[];r.jobs&&Array.isArray(r.jobs)&&r.jobs.length>0&&(h=r.jobs);const f=function(e,t,r){const n=r.keywords||"",s=i.parseCommaSeparated(n);let a="";!1!==r.searchInTitle&&(a+=(e.title||"")+" "),!1!==r.searchInDescription&&(a+=(e.description||"")+" "),!1!==r.searchInSkills&&(t&&Array.isArray(t)&&t.length>0?a+=t.map(e=>e.name||e).join(" ")+" ":e.jobs&&Array.isArray(e.jobs)&&e.jobs.length>0&&(a+=e.jobs.map(e=>"string"==typeof e?e:e.name||e).join(" ")+" "));return a=a.trim(),a?i.containsKeyword(a,s).found?null:{valid:!1,reason:"No matching keywords found in project"}:{valid:!1,reason:"No searchable content available (all search options are disabled)"}}(r,h,c);if(f)return f;const y=function(e,t){var r;const n=t.hideCurrencies||"";if(!n)return null;const s=i.parseCommaSeparated(n).map(e=>e.trim().toUpperCase()),a=((null==(r=e.currency)?void 0:r.code)||"").toUpperCase();return a&&s.includes(a)?{valid:!1,reason:"Currency in hide list"}:null}(r,c);if(y)return y;const b=function(e,t){var r,n,s;const a=!0===e.hourly||"hourly"===e.type,o=((null==(r=e.currency)?void 0:r.code)||e.currency_code||"USD").toUpperCase();if(a){const r=t.minRate||5,a=t.maxRate||100,c=(null==(n=e.budget)?void 0:n.minimum)||(null==(s=e.budget)?void 0:s.maximum)||0,l=i.convertToUSD(c,o);if(c>0&&(l<r||l>a))return{valid:!1,reason:`Hourly rate out of range (${c} ${o} â‰ˆ $${l.toFixed(2)} USD vs allowed $${r}-$${a} USD)`}}else{const r=t.minBudget||10,n=t.maxBudget||1e4,s=i.convertToUSD(e.budget.minimum||0,o),a=i.convertToUSD(e.budget.maximum||0,o);if(a<r||s>n)return{valid:!1,reason:`Budget out of range (${e.budget.minimum}-${e.budget.maximum} ${o} â‰ˆ $${s.toFixed(2)}-$${a.toFixed(2)} USD vs allowed $${r}-$${n} USD)`}}return null}(r,c);if(b)return b;const v=await async function(t,r,n){var s,a,c,l,u,d,g,m,p,h,f,w,y,b;const v=r.hideCountries||"";if(!v)return null;const k=i.parseCommaSeparated(v).map(e=>e.trim().toLowerCase());let $=(null==(c=null==(a=null==(s=t.owner)?void 0:s.location)?void 0:a.country)?void 0:c.name)||null,I=(null==(l=t.owner)?void 0:l.country)||null,S=(null==(d=null==(u=t.location)?void 0:u.country)?void 0:d.name)||null,P=t.country||null;if(!$&&!I&&!S&&!P&&t.id)try{const e=await o.fetchProjectDetails(t.id,n);if(e.success&&e.data){const t=e.data;if($=(null==(p=null==(m=null==(g=t.owner)?void 0:g.location)?void 0:m.country)?void 0:p.name)||null,I=(null==(h=t.owner)?void 0:h.country)||null,S=(null==(w=null==(f=t.location)?void 0:f.country)?void 0:w.name)||null,P=t.country||null,t.owner_id&&!$&&!I){const e=await o.fetchEmployerDetails(t.owner_id);e.success&&e.data&&(I=e.data.country||null,$=(null==(b=null==(y=e.data.location)?void 0:y.country)?void 0:b.name)||null)}}}catch(A){e.warn(`Failed to fetch project details for country check: ${A.message}`)}const j=($||I||S||P||"").toLowerCase().trim();if(!j)return{valid:!1,reason:"Cannot determine project country. Country filter is active, so project is rejected for safety."};if(k.some(e=>{const t=e.toLowerCase().trim();return j===t||new RegExp(`\\b${t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\b`,"i").test(j)}))return{valid:!1,reason:`Project from excluded country: ${$||I||S||P||"Unknown"}`};return null}(r,c,d);if(v)return v;const k=function(e,t){var r,n,s;const a=t.hideClients||"";if(!a)return null;const o=i.parseCommaSeparated(a).map(e=>e.trim().toLowerCase()),c=e.owner_id||(null==(r=e.owner)?void 0:r.id)||null,l=(null==(n=e.owner)?void 0:n.username)||null,u=(null==(s=e.owner)?void 0:s.name)||null,d=(c||"").toString().toLowerCase().trim(),g=(l||u||"").toLowerCase().trim();if((d||g)&&o.some(e=>{const t=e.toLowerCase().trim();return!(!g||g!==t)||!(!d||d!==t)||!(!g||!g.includes(t))}))return{valid:!1,reason:`Project from excluded client: ${g||d||"Unknown"}`};return null}(r,c);if(k)return k;const $=await w(r,h);if(!$.matchedProposal)return $;const I=await async function(t){const r=t.isNDA,n=t.isIPContract;if(!r&&!n)return null;const s=!r||l.isContractSigned(t.id,"nda"),a=!n||l.isContractSigned(t.id,"ip");if(s&&a)return null;const i=await l.getSignatureDataFromStorage();if(!i)return e.error("[Contract Check] FAILED: Signature data not found in storage"),{valid:!1,reason:"Contract signing required but signature data not found. Please configure your signature in settings."};const o=l.validateSignatureData(i);if(!o.valid)return e.error(`[Contract Check] FAILED: Signature data validation failed - ${o.error}`),{valid:!1,reason:`Invalid signature data: ${o.error}`};const c=await l.signAllRequired(t,i);return c.success?(e.success(`[Contract Check] SUCCESS: All required contracts signed for project ${t.id}`),null):(e.error(`[Contract Check] FAILED: Contract signing failed - ${c.error}`),e.error(`[Contract Check] Signing results - NDA signed: ${c.ndaSigned}, IP signed: ${c.ipSigned}`),{valid:!1,reason:`Failed to sign required contracts: ${c.error}`})}(r);if(I)return I;const S=await async function(e,t){const r=await o.checkCanBidOnProject(e.id,t);if(!r.success||!r.canBid)return{valid:!1,reason:r.message||"Cannot bid on this project (API check failed)"};return null}(r,d);return S||{valid:!0,reason:"Project meets all criteria",matchedProposal:$.matchedProposal}}async function b({project:n,proposal:s,skipBotStatusCheck:c=!1}){var l,u,d,m,p,h;e.success(`Placing bid on project: ${n.title} - ${s}`);const f=await t.get("bidding")||{},w=await t.get("auth")||{},y=null==(l=null==w?void 0:w.profile)?void 0:l.freelancer_auth_token;let b=(null==(u=null==w?void 0:w.profile)?void 0:u.membership)||"basic";const v=null==(d=null==w?void 0:w.profile)?void 0:d.membership_expires_at;if("premium"===b||"ultra"===b){if(!v||new Date(v)<new Date){e.warn(`Membership expired${v?` on ${new Date(v).toISOString()}`:" (null expiration)"}, refreshing auth`,!0);const r=null==(m=null==w?void 0:w.session)?void 0:m.refresh_token;if(r)try{const e=await a.refreshToken(r);if(e.success&&e.profile){const r={...w,user:e.user||w.user,session:e.session||w.session,profile:e.profile};await t.set("auth",r),b=e.profile.membership||"basic"}}catch(k){e.error(`Failed to refresh auth: ${k.message}`)}}}if(!c&&f.status!==r.RUNNING)throw e.error(`Bot is not running (status: ${f.status})`),new Error("Bot is not running");if(!y)throw e.error("Not logged in - auth token missing"),new Error("Not logged in - Please login to Freelancer.com first");try{const r=!0===n.hourly||"hourly"===n.type,c=((null==(p=n.currency)?void 0:p.code)||n.currency_code||"USD").toUpperCase(),l=i.calculateBidAmount(n.budget.minimum,n.budget.maximum,r,c),u=i.calculateDuration(n.budget.minimum,n.budget.maximum,r,c);let d=s;const m=await t.get("customai")||{};if(m.enabled)try{let r=(await t.get("profile")||{}).profile;if(!r){const n=await o.fetchUserProfile(y);n.success&&n.data?(r=n.data,await t.set("profile",{profile:r,skills:r.jobs||[],cacheTime:Date.now()})):e.warn(`Failed to fetch profile: ${n.message||"Unknown error"}`)}if(r){const t=n.description||n.preview_description||"",s=n.title||"",i=r.profile_description||r.description||"",o=await a.generateBid({provider:m.provider,model:m.model,max_token_count:m.maxTokenCount||1e3,system_prompt:m.systemPrompt||"",project_description:t,profile_description:i,project_title:s});o.success&&o.bidText?(e.success(`AI generation successful: ${o.bidText}`),d=o.bidText):e.warn(`AI generation failed: ${o.error||"Unknown error"}`)}else e.warn("No profile available for AI generation")}catch(k){e.warn(`AI generation error: ${k.message}`)}const f=null==(h=null==w?void 0:w.profile)?void 0:h.freelancer_user_id;if(!f)throw e.error("Could not get user ID from store"),new Error("Could not get user ID from store");const b={project_id:parseInt(n.id),bidder_id:parseInt(f),amount:parseInt(l),period:parseInt(u),milestone_percentage:100,description:d},v=await t.get("settings")||{},$=Math.max(0,(v.placeBidDelay||30)-3),I=n.submitdate||n.submit_date||n.time_submitted;let S=0;if(I){const e=new Date(1e3*I),t=new Date,r=1e3*$-1e3*Math.floor((t-e)/1e3);S=Math.max(1e3,r)}else S=1e3*$;const P=Date.now()+S;return g.push({bidData:b,authToken:y,project:n,bidAmount:l,submitAt:P,settings:await t.get("settings")||{}}),e.success(`Bid queued for project ${n.id}. Amount: ${l} ${c}, Duration: ${u} days`),{success:!0,message:"Bid queued for submission",bidAmount:l,queued:!0}}catch(k){throw e.error(`Failed to place bid for project ${n.id}: ${k.message}`),{success:!1,message:k.message||"Failed to place bid"}}}async function v(r,s){try{const a=await t.get("telegram")||{};if(a.enabled&&a.botToken&&a.chatId){const t=`âœ… <b>Bid Placed Successfully!</b>\n\nðŸ“‹ <b>Project:</b> ${r}\nðŸ”— <b>Link:</b> ${s||"N/A"}`,i=await n.sendMessage(a.botToken,a.chatId,t);i.success||e.warn(`Failed to send Telegram notification: ${i.message}`)}}catch(a){e.warn(`Error sending Telegram notification: ${a.message}`)}}async function k(n){e.success(`Processing project: ${n.title}`);const s=await t.get("bidding")||{};if((s.status||r.STOPPED)!==r.RUNNING)return;const a=s.processedProjectIds||[];a.includes(n.id)||(a.push(n.id),a.length>1e3&&a.shift(),await t.set("bidding",{...s,processedProjectIds:a}));const i=await y(n);if(i.valid){e.success("Project validation completed successfully - all checks passed!");try{await b({project:n,proposal:i.matchedProposal.text}),e.success(`Bid queued: ${n.title}`)}catch(o){e.error(`Failed to queue bid: ${o.message}`,!0)}}else e.error(`${n.title} - ${i.reason}`,!0)}async function $(){if(!d)try{let n=await t.get("bidding")||{},s=n.status||r.STOPPED;if(s!==r.RUNNING)return;d=!0;const a=await o.fetchActiveProjects();if(!a.success)return void e.error(`API Error: ${a.error}`);if(n=await t.get("bidding")||{},s=n.status||r.STOPPED,s!==r.RUNNING)return;const c=a.projects;if(!c||0===c.length)return;const l=c.map(i.normalizeProjectData);n=await t.get("bidding")||{};const u=new Set(n.processedProjectIds||[]),g=l.filter(e=>!u.has(e.id));if(0===g.length)return;e.success(`New projects found: ${g.length}`);for(const e of g){if(n=await t.get("bidding")||{},s=n.status||r.STOPPED,s!==r.RUNNING)break;await k(e)}}catch(n){e.error(`Error fetching/processing projects: ${n.message}`)}finally{d=!1}}async function I(){S();const n=(await t.get("settings")||{}).apiPullDelay||20,s=1e3*n;e.success(`Starting project search (interval: ${n}s)`),await $(),u=setInterval(async()=>{((await t.get("bidding")||{}).status||r.STOPPED)===r.RUNNING?await $():S()},s),m=setInterval(async()=>{((await t.get("bidding")||{}).status||r.STOPPED)===r.RUNNING?await async function(){var n,s,i;if(((await t.get("bidding")||{}).status||r.STOPPED)!==r.RUNNING)return void(g.length=0);const c=Date.now();for(let u=g.length-1;u>=0;u--){const d=g[u];if(d.submitAt<=c){if(g.splice(u,1),((await t.get("bidding")||{}).status||r.STOPPED)!==r.RUNNING){g.length=0;continue}try{const c=await o.submitBid(d.bidData,d.authToken);if(!c.success){e.error(`Bid failed: ${c.message||"Failed to submit bid"}`,!0);continue}e.success(`Bid placed with ID: ${c.bidId}`,!0);const u=await h(),g=await t.get("bidding")||{},m=(g.sessionBidsCount||0)+1;await t.set("bidding",{...g,sessionBidsCount:m,lastBidTime:(new Date).toISOString(),dailyBids:u});const p=await t.get("auth")||{};let w=(null==(n=null==p?void 0:p.profile)?void 0:n.membership)||"basic";const y=null==(s=null==p?void 0:p.profile)?void 0:s.membership_expires_at;if(("premium"===w||"ultra"===w)&&(!y||new Date(y)<new Date)){e.warn(`Membership expired${y?` on ${new Date(y).toISOString()}`:" (null expiration)"}, refreshing auth`,!0);const r=null==(i=null==p?void 0:p.session)?void 0:i.refresh_token;if(r)try{const e=await a.refreshToken(r);if(e.success&&e.profile){const r={...p,user:e.user||p.user,session:e.session||p.session,profile:e.profile};await t.set("auth",r),w=e.profile.membership||"basic"}}catch(l){e.error(`Failed to refresh auth: ${l.message}`)}}const b=await f(w);b.exceeded&&(e.success(`Daily bid limit reached (${b.limit} bids/day for ${w} plan)`,!0),await t.set("bidding",{...g,status:r.STOPPED,isRunning:!1,dailyBids:u}),S());const k=d.settings.autoBotCount||0;if(k>0&&m>=k&&(e.success(`Auto bot count limit reached (${m}/${k})`,!0),await t.set("bidding",{...g,status:r.STOPPED,isRunning:!1}),S()),d.settings.openInNewTab&&d.project.url)try{chrome.tabs.create({url:d.project.url,active:!1})}catch(l){e.warn(`Could not open project tab: ${l.message}`)}const $=await t.get("telegram")||{};$.enabled&&$.botToken&&$.chatId&&await v(d.project.title,d.project.url)}catch(l){e.error(`Error submitting bid from queue: ${l.message}`)}}}}():g.length=0},1e3)}function S(){u&&(clearInterval(u),u=null),m&&(clearInterval(m),m=null),g.length=0}async function P(e,r,s){var a;try{const r=await new Promise(e=>{chrome.tabs.query({url:"https://www.freelancer.com/*"},t=>{e(t||[])})});if(r&&r.length>0&&r.forEach(t=>{chrome.tabs.sendMessage(t.id,{action:"log",message:e.message,type:e.type,sender:e.sender,timestamp:e.timestamp}).catch(()=>{})}),e.showUI)try{const r=await t.get("logs")||{logs:[],unreadCount:0};r.logs=r.logs||[],r.unreadCount=r.unreadCount||0,r.logs.push({message:e.message,type:e.type,sender:e.sender||"unknown",timestamp:e.timestamp||Date.now()}),r.unreadCount=(r.unreadCount||0)+1,r.logs.length>100&&(r.logs=r.logs.slice(-100)),await t.set("logs",r)}catch(i){console.error("[Logger] Error adding log to storage:",i)}if(e.sendTelegram)try{const r=await t.get("telegram")||{};if(r.enabled&&r.botToken&&r.chatId){const t=`[${(null==(a=e.type)?void 0:a.toUpperCase())||"INFO"}] ${e.message}`;(await n.sendMessage(r.botToken,r.chatId,t)).success}}catch(i){console.error("[Logger] Error sending Telegram log:",i)}s({success:!0})}catch(i){console.error("[Logger] Error handling log:",i),s({success:!1,error:i.message})}}function j(r,n,s){return(async()=>{var n;try{await e.success(`Payment successful! Plan: ${r.plan||"N/A"}, Billing: ${r.billing_cycle||"N/A"}`,!0,!1);try{const r=await t.get("auth"),s=null==(n=null==r?void 0:r.session)?void 0:n.refresh_token;if(s){const n=await a.refreshToken(s);n.success&&n.session&&n.user?(await t.set("auth",{...r,isAuthenticated:!0,user:n.user,session:n.session,profile:n.profile||r.profile}),e.log("[Background] Token refreshed successfully after payment success")):e.warn(`[Background] Failed to refresh token after payment: ${n.error||"Unknown error"}`)}else e.warn("[Background] No refresh token available to refresh after payment success")}catch(i){e.warn(`[Background] Error refreshing token after payment success: ${i.message}`)}s({success:!0})}catch(o){console.error("[Background] Error handling payment success:",o),s({success:!1,error:o.message})}})(),!0}function A(t,r,n){return async function(){try{const t=chrome.identity.getRedirectURL("auth.html"),r=c(s.URL,s.ANON_KEY,{auth:{autoRefreshToken:!0,persistSession:!0}}),{data:n,error:a}=await r.auth.signInWithOAuth({provider:"google",options:{redirectTo:t,queryParams:{access_type:"offline",prompt:"consent"}}});if(a)throw e.error(`Supabase OAuth error: ${a.message}`),e.error(`OAuth error details: ${JSON.stringify(a)}`),new Error(a.message||"Google sign-in failed");if(!n||!n.url)throw e.error("No OAuth URL received from Supabase"),e.error(`OAuth data: ${JSON.stringify(n)}`),new Error("No OAuth URL received from Supabase");return new Promise((r,a)=>{chrome.identity.launchWebAuthFlow({url:n.url,interactive:!0},async n=>{if(chrome.runtime.lastError){const r=chrome.runtime.lastError.message||"Google sign-in cancelled";return e.error(`Chrome identity OAuth flow error: ${r}`),e.error(`Chrome runtime error: ${JSON.stringify(chrome.runtime.lastError)}`),void(r.includes("Authorization page could not be loaded")?a(new Error(`Authorization page could not be loaded. Please ensure the redirect URL (${t}) is added to Supabase Dashboard â†’ Authentication â†’ URL Configuration â†’ Redirect URLs`)):a(new Error(r)))}if(!n)return e.error("No redirect URL received from OAuth flow"),void a(new Error("No redirect URL received"));try{const t=new URL(n);let a=null,o=null,l=null;const u=t.searchParams.get("code")||(t.hash?new URLSearchParams(t.hash.substring(1)).get("code"):null);if(u)try{const t=c(s.URL,s.ANON_KEY,{auth:{autoRefreshToken:!0,persistSession:!0}}),{data:r,error:n}=await t.auth.exchangeCodeForSession(u);if(n||!(null==r?void 0:r.session))throw e.error(`Code exchange failed: ${(null==n?void 0:n.message)||"Unknown error"}`),new Error((null==n?void 0:n.message)||"Failed to exchange code for session");a=r.session.access_token,o=r.session.refresh_token,r.session.expires_at&&(l=1e3*r.session.expires_at)}catch(i){throw e.error(`Error exchanging code for session: ${i.message}`),i}else{if(t.hash){const e=t.hash.substring(1),r=new URLSearchParams(e);a=r.get("access_token"),o=r.get("refresh_token");const n=r.get("expires_in"),s=r.get("expires_at");s?l=1e3*parseInt(s):n&&(l=Date.now()+1e3*parseInt(n))}if(!a&&(a=t.searchParams.get("access_token"),o||(o=t.searchParams.get("refresh_token")),!l)){const e=t.searchParams.get("expires_at"),r=t.searchParams.get("expires_in");e?l=1e3*parseInt(e):r&&(l=Date.now()+1e3*parseInt(r))}if(a&&!o)try{const t=c(s.URL,s.ANON_KEY,{auth:{autoRefreshToken:!0,persistSession:!0}}),{data:r,error:n}=await t.auth.getSession();!n&&(null==r?void 0:r.session)?(o=r.session.refresh_token,!l&&r.session.expires_at&&(l=1e3*r.session.expires_at)):e.warn(`Could not get session from Supabase: ${(null==n?void 0:n.message)||"No session data"}`)}catch(i){e.warn(`Error getting session from Supabase: ${i.message}`)}}if(!a)throw e.error("No access token found in redirect URL"),e.error(`Full redirect URL: ${n}`),e.error(`URL search: ${t.search}`),e.error("URL hash: "+(t.hash?t.hash.substring(0,200)+"...":"none")),new Error("No access token found in redirect URL.");r({sessionToken:a,refreshToken:o,expiresAt:l})}catch(i){e.error(`Error processing OAuth callback: ${i.message}`),e.error(`Error stack: ${i.stack}`),a(i)}})})}catch(t){throw e.error(`Google sign-in error: ${t.message}`),e.error(`Error stack: ${t.stack}`),t}}(t.freelancerUserId,t.freelancerAuthToken).then(e=>{n(e)}).catch(e=>{n({error:e.message||"Google sign-in failed"})}),!0}function D(n,s,a){return(async()=>{var n,s;try{const e=await t.get("bidding")||{},i=await t.get("auth")||{},o=await t.get("filters")||{};if(e.status===r.RUNNING)return void a({success:!1,message:"Script is already running"});if(!i.isAuthenticated||!i.user||!i.session)return void a({success:!1,message:"âŒ Please login first!\n\nThe bot requires an active session to place bids."});const c=null==(n=null==i?void 0:i.profile)?void 0:n.freelancer_auth_token;if(!c)return void a({success:!1,message:"âŒ Please login to Freelancer.com first!\n\nThe bot requires an active session to place bids.\n\nPlease open Freelancer.com in a browser tab and login."});const l=o.keywords||"",u=[];if((!l||"string"==typeof l&&0===l.trim().split(",").filter(e=>e.trim()).length)&&u.push("Please enter at least one keyword"),(!o.minBudget||o.minBudget<=0)&&u.push("Minimum budget must be greater than 0"),null!==o.totalBids&&void 0!==o.totalBids&&o.totalBids<0&&u.push("Total bids must be 0 or greater (0 means unlimited)"),u.length>0)return void a({success:!1,message:u.join(", ")});await t.set("bidding",{...e,status:r.RUNNING,isRunning:!0,authToken:c,userId:null==(s=i.user)?void 0:s.id}),I(),a({success:!0,message:"Bot started successfully"})}catch(i){e.error(`Error starting bot: ${i.message}`),a({success:!1,message:i.message||"Failed to start bot"})}})(),!0}function C(n,s,a){return(async()=>{try{const e=await t.get("bidding")||{};await t.set("bidding",{...e,status:r.STOPPED,isRunning:!1}),S(),a({success:!0,message:"Bot stopped successfully"})}catch(n){e.error(`Error stopping bot: ${n.message}`),a({success:!1,message:n.message||"Failed to stop bot"})}})(),!0}function N(t,r,n){return(async()=>{try{if(!t.url)return void n({success:!1,message:"URL is required"});await new Promise((e,r)=>{chrome.tabs.create({url:t.url,active:!0},t=>{chrome.runtime.lastError?r(new Error(chrome.runtime.lastError.message)):e(t)})}),n({success:!0,message:"Tab opened successfully"})}catch(r){e.error(`Error opening tab: ${r.message}`),n({success:!1,message:r.message||"Failed to open tab"})}})(),!0}function x(t,r,n){return(async()=>{try{const e=await y(t.project,t.options||{});n({success:!0,result:e})}catch(r){e.error(`Error validating project: ${r.message}`),n({success:!1,error:r.message||"Failed to validate project",result:{valid:!1,reason:r.message||"Failed to validate project"}})}})(),!0}function E(t,r,n){return(async()=>{try{const e=await b({project:t.project,proposal:t.proposal,skipBotStatusCheck:t.skipBotStatusCheck||!1});n({success:!0,...e})}catch(r){e.error(`Error placing bid: ${r.message}`),n({success:!1,message:r.message||"Failed to place bid"})}})(),!0}async function T(){try{if(await t.get("_initialized"))return;const r=await t.get("settings");null==r&&await t.set("settings",{placeBidDelay:20,apiPullDelay:20,autoBotCount:10,openInNewTab:!0,openProjectModal:!0});const n=await t.get("filters");null==n&&await t.set("filters",{keywords:"mobile,web,shopify,vue,react,node,php,laravel,wordpress,javascript,html,css,python,django,flask,express,server,swift,kotlin,flutter,react native,ios,android,full stack,mern,mean,full stack,full-stack",minBudget:10,maxBudget:1e4,minRate:5,maxRate:100,totalBids:0,hideCurrencies:"",hideCountries:"",hideClients:"",searchInTitle:!0,searchInDescription:!0,searchInSkills:!0,hourlyProject:!0,fixedProject:!0,recruiterProject:!0,ndaIpProject:!0,projectPostTimeMinutes:0});const s=await t.get("template");null==s&&await t.set("template",{templates:[{id:"1",title:"Mobile Developer",keywords:"mobile,ios,android,react native,flutter,swift,kotlin",text:"Hi there!\nI'm an experienced mobile developer specializing in iOS and Android app development. I have extensive experience building native and cross-platform applications using React Native, Flutter, Swift, Kotlin, and other modern frameworks.\n\nI can help you build a high-quality mobile app that meets your requirements and delivers an excellent user experience. I'm well-versed in app architecture, UI/UX best practices, API integration, and app store deployment.\n\nLet's discuss your project requirements and I'll provide a detailed proposal tailored to your needs.\n\nLooking forward to working with you!"},{id:"2",title:"Web Developer",keywords:"web,frontend,react,vue,angular,javascript,html,css",text:"Hello!\nI'm a skilled web developer with expertise in modern frontend technologies including React, Vue, Angular, and vanilla JavaScript. I specialize in creating responsive, user-friendly web applications that perform well across all devices.\n\nI have experience with HTML5, CSS3, modern JavaScript (ES6+), and various frameworks and libraries. I can help you build a beautiful, functional website or web application that meets your business goals.\n\nI'm available to discuss your project and provide a comprehensive solution. Let me know if you have any questions!\n\nBest regards!"},{id:"3",title:"Backend Developer",keywords:"backend,api,nodejs,python,django,flask,express,server",text:"Hi,\nI'm an experienced backend developer specializing in building robust, scalable server-side applications and APIs. I work with technologies like Node.js, Python (Django, Flask), PHP, Java, and various databases.\n\nI can help you develop secure, efficient backend systems, RESTful APIs, database design, server architecture, and integration with third-party services. I focus on writing clean, maintainable code and following best practices.\n\nLet's discuss your backend requirements and I'll provide a detailed technical proposal.\n\nBest regards"},{id:"4",title:"Shopify Developer",keywords:"shopify,ecommerce,store,theme,app,liquid",text:"Hello!\nI'm a Shopify expert with extensive experience in developing and customizing Shopify stores. I specialize in theme development, custom app creation, store setup, and optimization.\n\nI can help you with:\n- Custom Shopify theme development\n- Store setup and configuration\n- App development and integration\n- Performance optimization\n- Liquid template customization\n- Payment and shipping setup\n\nI'm familiar with Shopify's ecosystem and can help you create a successful online store. Let's discuss your project!\n\nThanks!"},{id:"5",title:"Full Stack Developer",keywords:"fullstack,mern,mean,full stack,full-stack",text:"Hi there!\nI'm a full stack developer with expertise in both frontend and backend development. I work with modern tech stacks like MERN (MongoDB, Express, React, Node.js), MEAN, and other popular frameworks.\n\nI can handle everything from database design to frontend UI, API development, and deployment. This means you'll have a single developer who can manage your entire project from start to finish.\n\nLet's discuss your project requirements and I'll provide a comprehensive solution that covers all aspects of your application.\n\nLooking forward to working with you!"},{id:"6",title:"Default Template",keywords:"default,general,standard",text:"Hi there!\nI've reviewed your project requirements and I'm confident I can deliver excellent results. With my experience in this field, I can help you achieve your goals efficiently and effectively.\n\nI'm available to start immediately and can work within your timeline. Let's discuss the details and I'll provide a comprehensive solution tailored to your needs.\n\nLooking forward to working with you!"}]});const a=await t.get("customai");null==a&&await t.set("customai",{enabled:!1,provider:"openai",model:"gpt-4o-mini",maxTokenCount:1e3,useGithubUrl:!1,githubUrl:"",usePortfolioUrl:!1,portfolioUrl:"",useProjectLinks:!1,systemPrompt:"You are an expert freelance bid writer. Write compelling, professional bids that highlight the freelancer's relevant experience and skills. Keep bids concise (2-3 paragraphs), personalized, and focused on how the freelancer can solve the client's problem.",projectLinks:[]});const i=await t.get("telegram");null==i&&await t.set("telegram",{enabled:!1,botToken:"",chatId:""});const o=await t.get("logs");null==o&&await t.set("logs",{logs:[],unreadCount:0});const c=await t.get("bidding");null==c&&await t.set("bidding",{isRunning:!1,queue:[],sessionBids:0,lastBidTime:null});const l=await t.get("chat");null==l&&await t.set("chat",{threads:[]}),await t.set("_initialized",!0),e.success("All default values initialized successfully",!0)}catch(r){e.error(`Error initializing defaults: ${r.message}`,!0)}}chrome.runtime.onMessage.addListener((e,t,r)=>{const n={log:P,googleSignIn:A,startBot:D,stopBot:C,validateProject:x,placeBid:E,openTab:N,paymentSuccess:j}[e.action];if(n){const s=n(e,t,r);return void 0===s||s}return!0}),T(),"undefined"!=typeof chrome&&chrome.runtime?(chrome.runtime.onInstalled.addListener(async e=>{"install"===e.reason&&await T()}),chrome.runtime.onStartup.addListener(()=>{T()})):e.error("Chrome runtime not available!");
