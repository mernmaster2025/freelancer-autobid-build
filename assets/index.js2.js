import{l as e,s as t,S as r,a as n,t as a}from"./constants.js";import{u as i,a as o,s,c as l}from"./supabaseService.js";const c=new class{constructor(){this.lastError=null,this.signedContracts=new Map}isContractSigned(e,t){const r=`${e}_${t}`;return this.signedContracts.has(r)}markContractSigned(e,t){const r=`${e}_${t}`;this.signedContracts.set(r,!0)}extractDataAttribute(e,t){const r=new RegExp(`${t}\\s*=\\s*["']([^"']*)["']`),n=e.match(r);return n?n[1]:null}decodeHtmlEntities(e){return e?e.replace(/&#34;/g,'"'):e}async fetchNDAContract(t){try{const n=`https://www.freelancer.com/ajax/project/contract/initialize-nda-contract.php?project_id=${t}&type=nda`,a=await fetch(n,{headers:{Accept:"text/html"},credentials:"include"});if(!a.ok)throw new Error(`Failed to fetch NDA contract page. Status: ${a.status}`);const i=(await a.text()).match(/<[^>]*data-contract-control-container[^>]*>/s);if(!i)throw new Error("Could not find control container in the NDA contract HTML.");const o=i[0],s=this.extractDataAttribute(o,"data-signing-url"),l=this.extractDataAttribute(o,"data-signing-token"),c=this.extractDataAttribute(o,"data-signing-auth-token"),d=this.extractDataAttribute(o,"data-template-content-fields");let u=[];if(d)try{const e=this.decodeHtmlEntities(d);u=JSON.parse(e)}catch(r){e.warn(`Failed to parse template fields: ${r.message}`),u=[]}if(!s||!l||!c)throw new Error("Failed to parse one or more critical tokens from the NDA contract page.");return{signingUrl:s,signingToken:l,signingAuthToken:c,templateFields:u}}catch(r){throw this.lastError=r,r}}async fetchIPContract(e){try{const t=`https://www.freelancer.com/ajax/project/contract/initialize-freelancer-ip-contract.php?projectId=${e}`,r=await fetch(t,{headers:{Accept:"text/html"},credentials:"include"});if(!r.ok)throw new Error(`Failed to fetch IP Agreement contract page. Status: ${r.status}`);const n=(await r.text()).match(/<[^>]*data-contract-control-container[^>]*>/s);if(!n)throw new Error("Could not find control container in the IP Agreement contract HTML.");const a=n[0],i=this.extractDataAttribute(a,"data-signing-url"),o=this.extractDataAttribute(a,"data-signing-token"),s=this.extractDataAttribute(a,"data-signing-auth-token");if(!i||!o||!s)throw new Error("Failed to parse one or more critical tokens from the IP Agreement contract page.");return{signingUrl:i,signingToken:o,signingAuthToken:s}}catch(t){throw this.lastError=t,t}}async submitNDA(e,t){try{const r=`https://contracts.freelancer.com${e}`,n={full_name:t.fullName,signature_data:t.signatureData,signing_token:t.signingToken};t.templateFields&&Array.isArray(t.templateFields)&&t.templateFields.forEach(e=>{"full_address"===e.name&&(n[e.name]=t.fullAddress)});const a=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json",Authorization:t.signingAuthToken,Origin:"https://www.freelancer.com"},body:JSON.stringify(n)});if(!a.ok){const e=await a.text();throw new Error(`Server returned an error: ${a.status} ${a.statusText}. Response: ${e}`)}const i=await a.json();if("success"!==i.status||"string"!=typeof i.data)throw new Error(i.message||"NDA submission POST was not successful or did not return a verification URL.");return i.data}catch(r){throw this.lastError=r,r}}async submitIPDocument(e,t){try{const r=`https://contracts.freelancer.com${e}`,n={full_name:t.fullName,signature_data:t.signatureData,signing_token:t.signingToken},a=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json",Authorization:t.signingAuthToken,Origin:"https://www.freelancer.com"},body:JSON.stringify(n)});if(!a.ok){const e=await a.text();throw new Error(`Server returned an error: ${a.status} ${a.statusText}. Response: ${e}`)}const i=await a.json();if("success"!==i.status||"string"!=typeof i.data)throw new Error(i.message||"IP Agreement submission POST was not successful or did not return a verification URL.");return i.data}catch(r){throw this.lastError=r,r}}async verifySignature(e){try{const t=await fetch(e,{method:"GET",headers:{Origin:"https://www.freelancer.com"}});if(!t.ok)throw new Error(`Final verification step failed with status: ${t.status}`);return!0}catch(t){throw this.lastError=t,t}}async signNDAContract(t,r){try{if(this.isContractSigned(t,"nda"))return e.log(`NDA contract already signed for project ${t}`),{success:!0,alreadySigned:!0};e.log(`Signing NDA contract for project ${t}`);const n=await this.fetchNDAContract(t),a={...n,fullName:r.fullName,fullAddress:r.fullAddress,signatureData:r.signature},i=await this.submitNDA(n.signingUrl,a);return await this.verifySignature(i),this.markContractSigned(t,"nda"),e.success(`NDA contract signed successfully for project ${t}`),{success:!0}}catch(n){return e.error(`Failed to sign NDA contract for project ${t}: ${n.message}`),{success:!1,error:n.message}}}async signIPContract(t,r){try{if(this.isContractSigned(t,"ip"))return e.log(`IP contract already signed for project ${t}`),{success:!0,alreadySigned:!0};e.log(`Signing IP contract for project ${t}`);const n=await this.fetchIPContract(t),a={...n,fullName:r.fullName,signatureData:r.signature},i=await this.submitIPDocument(n.signingUrl,a);return await this.verifySignature(i),this.markContractSigned(t,"ip"),e.success(`IP contract signed successfully for project ${t}`),{success:!0}}catch(n){return e.error(`Failed to sign IP contract for project ${t}: ${n.message}`),{success:!1,error:n.message}}}async signAllRequired(t,r){try{const n=[];let a=!1,i=!1;const o=!0===t.isNDA||!0===t.nda||!0===t.ndaIp,s=!0===t.isIPContract||!0===t.ip||!0===t.ndaIp;if(o){const e=await this.signNDAContract(t.id,r);e.success?a=!0:n.push(`NDA: ${e.error}`)}if(s){const e=await this.signIPContract(t.id,r);e.success?i=!0:n.push(`IP Agreement: ${e.error}`)}return(!o||a)&&(!s||i)?(e.success(`All required contracts signed for project ${t.id}`),{success:!0,ndaSigned:a,ipSigned:i}):(e.error(`Failed to sign all required contracts for project ${t.id}: ${n.join("; ")}`),{success:!1,error:n.join("; "),ndaSigned:a,ipSigned:i})}catch(n){return e.error(`Error signing contracts for project ${t.id}: ${n.message}`),{success:!1,error:n.message}}}validateSignatureData(e){return e?e.signature&&e.signature.startsWith("data:image/png;base64,")?e.fullName&&e.fullName.trim()?e.fullAddress&&e.fullAddress.trim()?{valid:!0}:{valid:!1,error:"Full address is required"}:{valid:!1,error:"Full name is required"}:{valid:!1,error:"Invalid signature format. Must be a PNG data URI."}:{valid:!1,error:"Signature data not found"}}async getSignatureDataFromStorage(){try{const e=await t.get("signature")||{};return e.signature&&e.fullName&&e.fullAddress?e:null}catch(r){return e.error(`Failed to get signature data from storage: ${r.message}`),null}}};let d=null,u=!1;const g=[];let p=null;async function h(r,n){const a=await async function(r,n=[]){const a=(await t.get("template")||{}).templates||[];if(0===a.length)return e.warn("No templates found"),null;const o=(r+" "+n.map(e=>"string"==typeof e?e.toLowerCase():e&&e.name?e.name.toLowerCase():"").filter(e=>e.length>0).join(" ")).toLowerCase();for(const t of a){if(!t.text)continue;if(!(t.keywords&&t.keywords.trim().length>0))continue;const r=i.parseCommaSeparated(t.keywords);if(0!==r.length&&i.containsKeyword(o,r).found)return e.log(`Found matching template: ${t.title}`),t}const s=a[a.length-1];return s?(e.log(`No match found, using latest template: ${s.title}`),s):null}(r.title,n);return e.log(`Matched proposal: ${a?a.title:"none"}`,!1),a?{matchedProposal:a}:{valid:!1,reason:"Please add at least one proposal"}}async function m(r,n={}){var a;const{skipAutoValidation:s=!1}=n,l=await t.get("filters")||{},d=await t.get("auth")||{},u=null==(a=null==d?void 0:d.profile)?void 0:a.freelancer_auth_token;e.log(`Validating project: ${r.title}`,!1),e.log("[Validation Step 1/11] Checking project post time...");const g=function(e,t,r){if(r)return null;const n=t.projectPostTimeMinutes||0;if(0===n)return null;const a=e.submitdate||e.submit_date||e.time_submitted;if(!a)return null;const i=new Date(1e3*a),o=new Date,s=Math.floor((o-i)/6e4);return s>n?{valid:!1,reason:`Project was posted ${s} minute(s) ago, but minimum required is ${n} minute(s).`}:null}(r,l,s);if(g)return e.log(`[Validation Step 1/11] FAILED: ${g.reason}`),g;e.log("[Validation Step 1/11] PASSED: Project post time is valid"),e.log("[Validation Step 2/11] Checking project type (hourly/fixed/recruiter/NDA-IP)...");const p=function(e,t){const r=!0===e.hourly||"hourly"===e.type,n=!1===e.hourly||"fixed"===e.type,a=e.isRecruiter,i=e.isNDA||e.isIPContract;return!t.hourlyProject&&r?{valid:!1,reason:"Hourly projects are disabled in filters"}:!t.fixedProject&&n?{valid:!1,reason:"Fixed-price projects are disabled in filters"}:!t.recruiterProject&&a?{valid:!1,reason:"Recruiter projects are disabled in filters"}:!t.ndaIpProject&&i?{valid:!1,reason:"NDA/IP projects are disabled in filters"}:null}(r,l);if(p)return e.log(`[Validation Step 2/11] FAILED: ${p.reason}`),p;e.log("[Validation Step 2/11] PASSED: Project type is allowed"),e.log("[Validation Step 3/11] Checking bid count...");const m=function(e,t,r){var n,a;if(r)return null;const i=(null==(n=e.bidStats)?void 0:n.bidCount)||(null==(a=e.bid_stats)?void 0:a.bid_count)||e.bid_count||0,o=t.totalBids||0;return o>0&&i>o?{valid:!1,reason:`Project has ${i} bid(s), which exceeds the maximum allowed (${o}).`}:null}(r,l,s);if(m)return e.log(`[Validation Step 3/11] FAILED: ${m.reason}`),m;e.log("[Validation Step 3/11] PASSED: Bid count is within limits");let f=[];r.jobs&&Array.isArray(r.jobs)&&r.jobs.length>0&&(f=r.jobs,e.log(`Project has ${f.length} job/skill(s) listed`)),e.log("[Validation Step 4/11] Checking keywords match...");const w=function(e,t,r){const n=r.keywords||"",a=i.parseCommaSeparated(n);let o="";!1!==r.searchInTitle&&(o+=(e.title||"")+" "),!1!==r.searchInDescription&&(o+=(e.description||"")+" "),!1!==r.searchInSkills&&(t&&Array.isArray(t)&&t.length>0?o+=t.map(e=>e.name||e).join(" ")+" ":e.jobs&&Array.isArray(e.jobs)&&e.jobs.length>0&&(o+=e.jobs.map(e=>"string"==typeof e?e:e.name||e).join(" ")+" "));return o=o.trim(),o?i.containsKeyword(o,a).found?null:{valid:!1,reason:"No matching keywords found in project"}:{valid:!1,reason:"No searchable content available (all search options are disabled)"}}(r,f,l);if(w)return e.log(`[Validation Step 4/11] FAILED: ${w.reason}`),w;e.log("[Validation Step 4/11] PASSED: Keywords match found"),e.log("[Validation Step 5/11] Checking currency filter...");const y=function(e,t){var r;const n=t.hideCurrencies||"";if(!n)return null;const a=i.parseCommaSeparated(n).map(e=>e.trim().toUpperCase()),o=((null==(r=e.currency)?void 0:r.code)||"").toUpperCase();return o&&a.includes(o)?{valid:!1,reason:"Currency in hide list"}:null}(r,l);if(y)return e.log(`[Validation Step 5/11] FAILED: ${y.reason}`),y;e.log("[Validation Step 5/11] PASSED: Currency is not in hide list"),e.log("[Validation Step 6/11] Checking budget/rate range...");const b=function(e,t){var r,n,a;const o=!0===e.hourly||"hourly"===e.type,s=((null==(r=e.currency)?void 0:r.code)||e.currency_code||"USD").toUpperCase();if(o){const r=t.minRate||5,o=t.maxRate||100,l=(null==(n=e.budget)?void 0:n.minimum)||(null==(a=e.budget)?void 0:a.maximum)||0,c=i.convertToUSD(l,s);if(l>0&&(c<r||c>o))return{valid:!1,reason:`Hourly rate out of range (${l} ${s} ≈ $${c.toFixed(2)} USD vs allowed $${r}-$${o} USD)`}}else{const r=t.minBudget||10,n=t.maxBudget||1e4,a=i.convertToUSD(e.budget.minimum||0,s),o=i.convertToUSD(e.budget.maximum||0,s);if(o<r||a>n)return{valid:!1,reason:`Budget out of range (${e.budget.minimum}-${e.budget.maximum} ${s} ≈ $${a.toFixed(2)}-$${o.toFixed(2)} USD vs allowed $${r}-$${n} USD)`}}return null}(r,l);if(b)return e.log(`[Validation Step 6/11] FAILED: ${b.reason}`),b;e.log("[Validation Step 6/11] PASSED: Budget/rate is within range"),e.log("[Validation Step 7/11] Checking country filter...");const v=await async function(t,r,n){var a,s,l,c,d,u,g,p,h,m,f,w,y,b;const v=r.hideCountries||"";if(!v)return null;const $=i.parseCommaSeparated(v).map(e=>e.trim().toLowerCase());let S=(null==(l=null==(s=null==(a=t.owner)?void 0:a.location)?void 0:s.country)?void 0:l.name)||null,P=(null==(c=t.owner)?void 0:c.country)||null,k=(null==(u=null==(d=t.location)?void 0:d.country)?void 0:u.name)||null,A=t.country||null;if(!S&&!P&&!k&&!A&&t.id)try{const e=await o.fetchProjectDetails(t.id,n);if(e.success&&e.data){const t=e.data;if(S=(null==(h=null==(p=null==(g=t.owner)?void 0:g.location)?void 0:p.country)?void 0:h.name)||null,P=(null==(m=t.owner)?void 0:m.country)||null,k=(null==(w=null==(f=t.location)?void 0:f.country)?void 0:w.name)||null,A=t.country||null,t.owner_id&&!S&&!P){const e=await o.fetchEmployerDetails(t.owner_id);e.success&&e.data&&(P=e.data.country||null,S=(null==(b=null==(y=e.data.location)?void 0:y.country)?void 0:b.name)||null)}}}catch(I){e.warn(`Failed to fetch project details for country check: ${I.message}`)}const C=(S||P||k||A||"").toLowerCase().trim();if(!C)return{valid:!1,reason:"Cannot determine project country. Country filter is active, so project is rejected for safety."};if($.some(e=>{const t=e.toLowerCase().trim();return C===t||new RegExp(`\\b${t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\b`,"i").test(C)}))return{valid:!1,reason:`Project from excluded country: ${S||P||k||A||"Unknown"}`};return null}(r,l,u);if(v)return e.log(`[Validation Step 7/11] FAILED: ${v.reason}`),v;e.log("[Validation Step 7/11] PASSED: Country is not in hide list"),e.log("[Validation Step 8/11] Checking client filter...");const $=function(e,t){var r,n,a;const o=t.hideClients||"";if(!o)return null;const s=i.parseCommaSeparated(o).map(e=>e.trim().toLowerCase()),l=e.owner_id||(null==(r=e.owner)?void 0:r.id)||null,c=(null==(n=e.owner)?void 0:n.username)||null,d=(null==(a=e.owner)?void 0:a.name)||null,u=(l||"").toString().toLowerCase().trim(),g=(c||d||"").toLowerCase().trim();if((u||g)&&s.some(e=>{const t=e.toLowerCase().trim();return!(!g||g!==t)||!(!u||u!==t)||!(!g||!g.includes(t))}))return{valid:!1,reason:`Project from excluded client: ${g||u||"Unknown"}`};return null}(r,l);if($)return e.log(`[Validation Step 8/11] FAILED: ${$.reason}`),$;e.log("[Validation Step 8/11] PASSED: Client is not in hide list"),e.log("[Validation Step 9/11] Checking for matching proposal...");const S=await h(r,f);if(!S.matchedProposal)return e.log(`[Validation Step 9/11] FAILED: ${S.reason}`),S;e.log("[Validation Step 9/11] PASSED: Matching proposal found"),e.log("[Validation Step 10/11] Checking NDA/IP contract requirements...");const P=await async function(t){e.log(`[Contract Check] Starting contract check for project ${t.id}`);const r=t.isNDA,n=t.isIPContract;if(e.log(`[Contract Check] Contract requirements - NDA: ${r}, IP: ${n}`),!r&&!n)return e.log("[Contract Check] No contracts required for this project"),null;e.log("[Contract Check] Checking if contracts are already signed...");const a=!r||c.isContractSigned(t.id,"nda"),i=!n||c.isContractSigned(t.id,"ip");if(e.log(`[Contract Check] Contract status - NDA signed: ${a}, IP signed: ${i}`),a&&i)return e.log("[Contract Check] All required contracts are already signed, skipping signing process"),null;e.log("[Contract Check] Contracts need to be signed. Fetching signature data from storage...");const o=await c.getSignatureDataFromStorage();if(!o)return e.error("[Contract Check] FAILED: Signature data not found in storage"),{valid:!1,reason:"Contract signing required but signature data not found. Please configure your signature in settings."};e.log("[Contract Check] Signature data found. Validating signature data..."),e.log(`[Contract Check] Signature data details - Full name: ${o.fullName?"Present":"Missing"}, Full address: ${o.fullAddress?"Present":"Missing"}, Signature: ${o.signature?"Present":"Missing"}`);const s=c.validateSignatureData(o);if(!s.valid)return e.error(`[Contract Check] FAILED: Signature data validation failed - ${s.error}`),{valid:!1,reason:`Invalid signature data: ${s.error}`};e.log("[Contract Check] Signature data validation passed"),e.log("[Contract Check] Starting contract signing process..."),r&&!a&&e.log(`[Contract Check] Signing NDA contract for project ${t.id}`),n&&!i&&e.log(`[Contract Check] Signing IP contract for project ${t.id}`);const l=await c.signAllRequired(t,o);return l.success?(e.success(`[Contract Check] SUCCESS: All required contracts signed for project ${t.id}`),e.log(`[Contract Check] Final status - NDA signed: ${l.ndaSigned}, IP signed: ${l.ipSigned}`),null):(e.error(`[Contract Check] FAILED: Contract signing failed - ${l.error}`),e.error(`[Contract Check] Signing results - NDA signed: ${l.ndaSigned}, IP signed: ${l.ipSigned}`),{valid:!1,reason:`Failed to sign required contracts: ${l.error}`})}(r);if(P)return e.log(`[Validation Step 10/11] FAILED: ${P.reason}`),P;e.log("[Validation Step 10/11] PASSED: Contract requirements satisfied"),e.log("[Validation Step 11/11] Checking if can bid on project (API check)...");const k=await async function(e,t){const r=await o.checkCanBidOnProject(e.id,t);if(!r.success||!r.canBid)return{valid:!1,reason:r.message||"Cannot bid on this project (API check failed)"};return null}(r,u);return k?(e.log(`[Validation Step 11/11] FAILED: ${k.reason}`),k):(e.log("[Validation Step 11/11] PASSED: Can bid on project"),e.success("Project validation completed successfully - all checks passed!"),{valid:!0,reason:"Project meets all criteria",matchedProposal:S.matchedProposal})}async function f({project:n,proposal:a,skipBotStatusCheck:l=!1}){var c,d,u,p,h;e.log(`[PlaceBid] Starting bid placement for project ${n.id}`),e.log(`[PlaceBid] Project title: ${n.title}`),e.log(`[PlaceBid] Skip bot status check: ${l}`);const m=await t.get("bidding")||{},f=await t.get("auth")||{},w=null==(c=null==f?void 0:f.profile)?void 0:c.freelancer_auth_token;if(e.log(`[PlaceBid] Bot status: ${m.status}`),e.log(`[PlaceBid] Auth token present: ${!!w}`),!l&&m.status!==r.RUNNING)throw e.error(`[PlaceBid] FAILED: Bot is not running (status: ${m.status})`),new Error("Bot is not running");if(!w)throw e.error("[PlaceBid] FAILED: Not logged in - auth token missing"),new Error("Not logged in - Please login to Freelancer.com first");try{const r=!0===n.hourly||"hourly"===n.type,l=((null==(d=n.currency)?void 0:d.code)||n.currency_code||"USD").toUpperCase();e.log("[PlaceBid] Project type: "+(r?"Hourly":"Fixed")),e.log(`[PlaceBid] Project currency: ${l}`),e.log(`[PlaceBid] Budget range: ${(null==(u=n.budget)?void 0:u.minimum)||0} - ${(null==(p=n.budget)?void 0:p.maximum)||0} ${l}`);const c=i.calculateBidAmount(n.budget.minimum,n.budget.maximum,r,l),m=i.calculateDuration(n.budget.minimum,n.budget.maximum,r,l);e.log(`[PlaceBid] Calculated bid amount: ${c} ${l}`),e.log(`[PlaceBid] Calculated duration: ${m} days`);let b=a.description;e.log(`[PlaceBid] Initial bid description length: ${b.length} characters`);const v=await t.get("customai")||{};if(e.log(`[PlaceBid] Custom AI enabled: ${v.enabled||!1}`),v.enabled)try{e.log("[PlaceBid] Generating AI bid description...");let r=(await t.get("profile")||{}).profile;if(r)e.log("[PlaceBid] Using cached profile");else{e.log("[PlaceBid] Profile not in cache, fetching from API...");const n=await o.fetchUserProfile(w);n.success&&n.data?(r=n.data,e.log("[PlaceBid] Profile fetched successfully"),await t.set("profile",{profile:r,skills:r.jobs||[],cacheTime:Date.now()})):e.warn(`[PlaceBid] Failed to fetch profile: ${n.message||"Unknown error"}`)}if(r){const t=n.description||n.preview_description||"",a=n.title||"",i=r.profile_description||r.description||"";e.log(`[PlaceBid] AI generation params - Provider: ${v.provider}, Model: ${v.model}`),e.log(`[PlaceBid] Project title length: ${a.length}, Description length: ${t.length}`),e.log(`[PlaceBid] Profile description length: ${i.length}`);const o=await s.generateBid({provider:v.provider,model:v.model,max_token_count:v.maxTokenCount||1e3,system_prompt:v.systemPrompt||"",project_description:t,profile_description:i,project_title:a});o.success&&o.bidText?(b=o.bidText,e.log(`[PlaceBid] AI bid generated successfully, length: ${b.length} characters`)):e.warn(`[PlaceBid] AI generation failed: ${o.error||"Unknown error"}`)}else e.warn("[PlaceBid] No profile available for AI generation")}catch(y){e.warn(`[PlaceBid] AI generation error: ${y.message}`)}const $=null==(h=null==f?void 0:f.profile)?void 0:h.freelancer_user_id;if(e.log(`[PlaceBid] User ID: ${$||"NOT FOUND"}`),!$)throw e.error("[PlaceBid] FAILED: Could not get user ID from store"),new Error("Could not get user ID from store");const S={project_id:parseInt(n.id),bidder_id:parseInt($),amount:parseInt(c),period:parseInt(m),milestone_percentage:100,description:b};e.log("[PlaceBid] Bid data prepared:"),e.log(`[PlaceBid]   - Project ID: ${S.project_id}`),e.log(`[PlaceBid]   - Bidder ID: ${S.bidder_id}`),e.log(`[PlaceBid]   - Amount: ${S.amount}`),e.log(`[PlaceBid]   - Period: ${S.period} days`),e.log(`[PlaceBid]   - Description length: ${S.description.length} characters`);const P=(await t.get("settings")||{}).placeBidDelay||30,k=n.submitdate||n.submit_date||n.time_submitted;e.log(`[PlaceBid] Place bid delay setting: ${P} seconds`),e.log(`[PlaceBid] Project submit date: ${k?new Date(1e3*k).toISOString():"Not available"}`);let A=0;if(k){const t=new Date(1e3*k),r=new Date,n=Math.floor((r-t)/1e3),a=1e3*P-1e3*n;A=Math.max(1e3,a),e.log(`[PlaceBid] Project posted ${n} seconds ago`),e.log(`[PlaceBid] Calculated delay: ${A}ms (${(A/1e3).toFixed(1)}s)`)}else A=1e3*P,e.log(`[PlaceBid] No submit date, using full delay: ${A}ms (${P}s)`);const C=Date.now()+A,I=new Date(C);return e.log(`[PlaceBid] Bid will be submitted at: ${I.toISOString()}`),g.push({bidData:S,authToken:w,project:n,bidAmount:c,submitAt:C,settings:await t.get("settings")||{}}),e.log(`[PlaceBid] Bid added to queue. Queue length: ${g.length}`),e.success(`[PlaceBid] SUCCESS: Bid queued for project ${n.id}. Amount: ${c} ${l}, Duration: ${m} days`),{success:!0,message:"Bid queued for submission",bidAmount:c,queued:!0}}catch(y){throw e.error(`[PlaceBid] ERROR: Failed to place bid for project ${n.id}: ${y.message}`),e.error(`[PlaceBid] Error stack: ${y.stack||"No stack trace"}`),{success:!1,message:y.message||"Failed to place bid"}}}async function w(n){const a=await t.get("bidding")||{};if((a.status||r.STOPPED)!==r.RUNNING)return;const i=a.processedProjectIds||[];i.includes(n.id)||(i.push(n.id),i.length>1e3&&i.shift(),await t.set("bidding",{...a,processedProjectIds:i}));if(((await t.get("bidding")||{}).status||r.STOPPED)!==r.RUNNING)return;const o=await m(n);if(!o.valid)return void e.error(`${n.title} - ${o.reason}`,!0);if(((await t.get("bidding")||{}).status||r.STOPPED)===r.RUNNING)try{await f({project:n,proposal:o.matchedProposal}),e.success(`Bid queued: ${n.title}`,!0)}catch(s){e.error(`Failed to queue bid: ${s.message}`,!0)}}async function y(){if(!u)try{const n=await t.get("bidding")||{};if((n.status||r.STOPPED)!==r.RUNNING)return;u=!0;const a=await o.fetchActiveProjects();if(!a.success)return void e.error(`API Error: ${a.error}`);const s=await t.get("bidding")||{};if((s.status||r.STOPPED)!==r.RUNNING)return;const l=a.projects;if(!l||0===l.length)return void e.log("No projects found");const c=l.map(i.normalizeProjectData),d=await t.get("bidding")||{},g=new Set(d.processedProjectIds||[]),p=c.filter(e=>!g.has(e.id));if(e.log(`Found ${l.length} projects, ${p.length} new to process`),0===p.length)return;for(const e of p){const n=await t.get("bidding")||{};if((n.status||r.STOPPED)!==r.RUNNING)break;await w(e)}}catch(n){e.error(`Error fetching/processing projects: ${n.message}`)}finally{u=!1}}async function b(){v();const n=(await t.get("settings")||{}).apiPullDelay||20,a=1e3*n;e.log(`Starting project search (interval: ${n}s)`),await y(),d=setInterval(async()=>{((await t.get("bidding")||{}).status||r.STOPPED)===r.RUNNING?await y():v()},a),p=setInterval(async()=>{((await t.get("bidding")||{}).status||r.STOPPED)===r.RUNNING?await async function(){if(((await t.get("bidding")||{}).status||r.STOPPED)!==r.RUNNING)return void(g.length=0);if(0===g.length)return;const n=Date.now();for(let i=g.length-1;i>=0;i--){const s=g[i];if(s.submitAt<=n){if(g.splice(i,1),((await t.get("bidding")||{}).status||r.STOPPED)!==r.RUNNING)continue;e.log(`Processing bid queue (${g.length+1} remaining)`,!0);try{const n=await o.submitBid(s.bidData,s.authToken);if(!n.success){e.error(`Bid failed: ${n.message||"Failed to submit bid"}`,!0);continue}e.success(`Bid placed with ID: ${n.bidId}`,!0);const i=await t.get("bidding")||{},l=(i.sessionBidsCount||0)+1;await t.set("bidding",{...i,sessionBidsCount:l,lastBidTime:(new Date).toISOString()});const c=s.settings.autoBotCount||0;if(c>0&&l>=c&&(e.success(`Auto bot count limit reached (${l}/${c})`,!0),await t.set("bidding",{...i,status:r.STOPPED,isRunning:!1}),v()),s.settings.openInNewTab&&s.project.url)try{chrome.tabs.create({url:s.project.url,active:!1})}catch(a){e.warn(`Could not open project tab: ${a.message}`)}e.log(`[Telegram] Would send bid notification for project: ${s.project.title}`)}catch(a){e.error(`Error submitting bid from queue: ${a.message}`)}}}}():g.length=0},1e3)}function v(){(d||p)&&e.log("Stopping project search"),d&&(clearInterval(d),d=null),p&&(clearInterval(p),p=null),g.length=0}async function $(r,n,i){var o;try{const n=await new Promise(e=>{chrome.tabs.query({url:"https://www.freelancer.com/*"},t=>{e(t||[])})});if(n&&n.length>0&&n.forEach(e=>{chrome.tabs.sendMessage(e.id,{action:"log",message:r.message,type:r.type,sender:r.sender,timestamp:r.timestamp}).catch(()=>{})}),r.showUI)try{const e=await t.get("logs")||{logs:[],unreadCount:0};e.logs=e.logs||[],e.unreadCount=e.unreadCount||0,e.logs.push({message:r.message,type:r.type,sender:r.sender||"unknown",timestamp:r.timestamp||Date.now()}),e.unreadCount=(e.unreadCount||0)+1,e.logs.length>100&&(e.logs=e.logs.slice(-100)),await t.set("logs",e)}catch(s){console.error("[Logger] Error adding log to storage:",s)}if(r.sendTelegram)try{const n=await t.get("telegram")||{};if(n.enabled&&n.botToken&&n.chatId){const t=`[${(null==(o=r.type)?void 0:o.toUpperCase())||"INFO"}] ${r.message}`,i=await a.sendMessage(n.botToken,n.chatId,t);i.success||e.log(`[Telegram] Failed to send: ${i.message}`)}}catch(s){console.error("[Logger] Error sending Telegram log:",s)}i({success:!0})}catch(s){console.error("[Logger] Error handling log:",s),i({success:!1,error:s.message})}}function S(t,r,a){return async function(){try{const t=chrome.identity.getRedirectURL("auth.html");e.log(`OAuth redirect URL: ${t}`),e.log("IMPORTANT: Add this URL to Supabase Dashboard → Authentication → URL Configuration → Redirect URLs");const r=l(n.URL,n.ANON_KEY,{auth:{autoRefreshToken:!0,persistSession:!0}}),{data:a,error:i}=await r.auth.signInWithOAuth({provider:"google",options:{redirectTo:t,queryParams:{access_type:"offline",prompt:"consent"}}});if(i)throw e.error(`Supabase OAuth error: ${i.message}`),e.error(`OAuth error details: ${JSON.stringify(i)}`),new Error(i.message||"Google sign-in failed");if(!a||!a.url)throw e.error("No OAuth URL received from Supabase"),e.error(`OAuth data: ${JSON.stringify(a)}`),new Error("No OAuth URL received from Supabase");return e.log(`OAuth URL received from Supabase (length: ${a.url.length})`),e.log(`OAuth URL preview: ${a.url.substring(0,150)}...`),new Promise((r,i)=>{e.log("Launching Chrome identity OAuth flow..."),chrome.identity.launchWebAuthFlow({url:a.url,interactive:!0},async a=>{if(chrome.runtime.lastError){const r=chrome.runtime.lastError.message||"Google sign-in cancelled";return e.error(`Chrome identity OAuth flow error: ${r}`),e.error(`Chrome runtime error: ${JSON.stringify(chrome.runtime.lastError)}`),void(r.includes("Authorization page could not be loaded")?i(new Error(`Authorization page could not be loaded. Please ensure the redirect URL (${t}) is added to Supabase Dashboard → Authentication → URL Configuration → Redirect URLs`)):i(new Error(r)))}if(!a)return e.error("No redirect URL received from OAuth flow"),void i(new Error("No redirect URL received"));try{e.log(`OAuth callback received (length: ${a.length})`),e.log(`Full OAuth callback URL: ${a}`);const t=new URL(a);let i=null,s=null,c=null;const d=t.searchParams.get("code")||(t.hash?new URLSearchParams(t.hash.substring(1)).get("code"):null);if(d){e.log("Code parameter found, exchanging for session...");try{const t=l(n.URL,n.ANON_KEY,{auth:{autoRefreshToken:!0,persistSession:!0}}),{data:r,error:a}=await t.auth.exchangeCodeForSession(d);if(a||!(null==r?void 0:r.session))throw e.error(`Code exchange failed: ${(null==a?void 0:a.message)||"Unknown error"}`),new Error((null==a?void 0:a.message)||"Failed to exchange code for session");e.log("Session obtained from code exchange"),i=r.session.access_token,s=r.session.refresh_token,r.session.expires_at&&(c=1e3*r.session.expires_at),e.log("Access token: "+(i?"found":"not found")),e.log("Refresh token: "+(s?"found":"not found"))}catch(o){throw e.error(`Error exchanging code for session: ${o.message}`),o}}else{if(e.log("Extracting tokens from URL hash fragment..."),t.hash){e.log(`Checking hash fragment: ${t.hash.substring(0,100)}...`);const r=t.hash.substring(1),n=new URLSearchParams(r);i=n.get("access_token"),s=n.get("refresh_token");const a=n.get("expires_in"),o=n.get("expires_at");e.log("Access token: "+(i?"found":"not found")),e.log("Refresh token: "+(s?"found":"not found")),e.log(`Expires in: ${a||"not found"}`),e.log(`Expires at: ${o||"not found"}`),o?(c=1e3*parseInt(o),e.log(`Using expires_at from URL: ${c}`)):a&&(c=Date.now()+1e3*parseInt(a),e.log(`Calculated expires_at from expires_in: ${c}`))}if(!i&&(e.log("Checking query parameters for access token..."),i=t.searchParams.get("access_token"),s||(s=t.searchParams.get("refresh_token")),!c)){const e=t.searchParams.get("expires_at"),r=t.searchParams.get("expires_in");e?c=1e3*parseInt(e):r&&(c=Date.now()+1e3*parseInt(r))}if(i&&!s){e.log("Access token found but refresh token missing, attempting to get session from Supabase...");try{const t=l(n.URL,n.ANON_KEY,{auth:{autoRefreshToken:!0,persistSession:!0}}),{data:r,error:a}=await t.auth.getSession();!a&&(null==r?void 0:r.session)?(e.log("Session retrieved from Supabase"),s=r.session.refresh_token,!c&&r.session.expires_at&&(c=1e3*r.session.expires_at),e.log("Refresh token from session: "+(s?"found":"not found"))):e.warn(`Could not get session from Supabase: ${(null==a?void 0:a.message)||"No session data"}`)}catch(o){e.warn(`Error getting session from Supabase: ${o.message}`)}}}if(!i)throw e.error("No access token found in redirect URL"),e.error(`Full redirect URL: ${a}`),e.error(`URL search: ${t.search}`),e.error("URL hash: "+(t.hash?t.hash.substring(0,200)+"...":"none")),new Error("No access token found in redirect URL.");e.log("OAuth flow completed successfully"),e.log(`Final tokens - Access: ${i?"found":"missing"}, Refresh: ${s?"found":"missing"}`),r({sessionToken:i,refreshToken:s,expiresAt:c})}catch(o){e.error(`Error processing OAuth callback: ${o.message}`),e.error(`Error stack: ${o.stack}`),i(o)}})})}catch(t){throw e.error(`Google sign-in error: ${t.message}`),e.error(`Error stack: ${t.stack}`),t}}(t.freelancerUserId,t.freelancerAuthToken).then(e=>{a(e)}).catch(e=>{a({error:e.message||"Google sign-in failed"})}),!0}function P(n,a,i){return(async()=>{var n,a;try{const e=await t.get("bidding")||{},o=await t.get("auth")||{},s=await t.get("filters")||{};if(e.status===r.RUNNING)return void i({success:!1,message:"Script is already running"});if(!o.isAuthenticated||!o.user||!o.session)return void i({success:!1,message:"❌ Please login first!\n\nThe bot requires an active session to place bids."});const l=null==(n=null==o?void 0:o.profile)?void 0:n.freelancer_auth_token;if(!l)return void i({success:!1,message:"❌ Please login to Freelancer.com first!\n\nThe bot requires an active session to place bids.\n\nPlease open Freelancer.com in a browser tab and login."});const c=s.keywords||"",d=[];if((!c||"string"==typeof c&&0===c.trim().split(",").filter(e=>e.trim()).length)&&d.push("Please enter at least one keyword"),(!s.minBudget||s.minBudget<=0)&&d.push("Minimum budget must be greater than 0"),null!==s.totalBids&&void 0!==s.totalBids&&s.totalBids<0&&d.push("Total bids must be 0 or greater (0 means unlimited)"),d.length>0)return void i({success:!1,message:d.join(", ")});await t.set("bidding",{...e,status:r.RUNNING,isRunning:!0,authToken:l,userId:null==(a=o.user)?void 0:a.id}),b(),i({success:!0,message:"Bot started successfully"})}catch(o){e.error(`Error starting bot: ${o.message}`),i({success:!1,message:o.message||"Failed to start bot"})}})(),!0}function k(n,a,i){return(async()=>{try{const e=await t.get("bidding")||{};await t.set("bidding",{...e,status:r.STOPPED,isRunning:!1}),v(),i({success:!0,message:"Bot stopped successfully"})}catch(n){e.error(`Error stopping bot: ${n.message}`),i({success:!1,message:n.message||"Failed to stop bot"})}})(),!0}function A(t,r,n){return(async()=>{try{const e=await m(t.project,t.options||{});n({success:!0,result:e})}catch(r){e.error(`Error validating project: ${r.message}`),n({success:!1,error:r.message||"Failed to validate project",result:{valid:!1,reason:r.message||"Failed to validate project"}})}})(),!0}function C(t,r,n){return(async()=>{try{const e=await f({project:t.project,proposal:t.proposal,skipBotStatusCheck:t.skipBotStatusCheck||!1});n({success:!0,...e})}catch(r){e.error(`Error placing bid: ${r.message}`),n({success:!1,message:r.message||"Failed to place bid"})}})(),!0}async function I(){try{if(await t.get("_initialized"))return void e.log("Extension already initialized, skipping defaults");e.log("Initializing default values for first install");const r=await t.get("settings");null==r&&(await t.set("settings",{placeBidDelay:20,apiPullDelay:20,autoBotCount:10,openInNewTab:!0,openProjectModal:!0}),e.log("Default settings initialized"));const n=await t.get("filters");null==n&&(await t.set("filters",{keywords:"mobile,web,shopify,vue,react,node,php,laravel,wordpress,javascript,html,css,python,django,flask,express,server,swift,kotlin,flutter,react native,ios,android,full stack,mern,mean,full stack,full-stack",minBudget:10,maxBudget:1e4,minRate:5,maxRate:100,totalBids:0,hideCurrencies:"",hideCountries:"",hideClients:"",searchInTitle:!0,searchInDescription:!0,searchInSkills:!0,hourlyProject:!0,fixedProject:!0,recruiterProject:!0,ndaIpProject:!0,projectPostTimeMinutes:0}),e.log("Default filters initialized"));const a=await t.get("template");null==a&&(await t.set("template",{templates:[{id:"1",title:"Mobile Developer",keywords:"mobile,ios,android,react native,flutter,swift,kotlin",text:"Hi there!\nI'm an experienced mobile developer specializing in iOS and Android app development. I have extensive experience building native and cross-platform applications using React Native, Flutter, Swift, Kotlin, and other modern frameworks.\n\nI can help you build a high-quality mobile app that meets your requirements and delivers an excellent user experience. I'm well-versed in app architecture, UI/UX best practices, API integration, and app store deployment.\n\nLet's discuss your project requirements and I'll provide a detailed proposal tailored to your needs.\n\nLooking forward to working with you!"},{id:"2",title:"Web Developer",keywords:"web,frontend,react,vue,angular,javascript,html,css",text:"Hello!\nI'm a skilled web developer with expertise in modern frontend technologies including React, Vue, Angular, and vanilla JavaScript. I specialize in creating responsive, user-friendly web applications that perform well across all devices.\n\nI have experience with HTML5, CSS3, modern JavaScript (ES6+), and various frameworks and libraries. I can help you build a beautiful, functional website or web application that meets your business goals.\n\nI'm available to discuss your project and provide a comprehensive solution. Let me know if you have any questions!\n\nBest regards!"},{id:"3",title:"Backend Developer",keywords:"backend,api,nodejs,python,django,flask,express,server",text:"Hi,\nI'm an experienced backend developer specializing in building robust, scalable server-side applications and APIs. I work with technologies like Node.js, Python (Django, Flask), PHP, Java, and various databases.\n\nI can help you develop secure, efficient backend systems, RESTful APIs, database design, server architecture, and integration with third-party services. I focus on writing clean, maintainable code and following best practices.\n\nLet's discuss your backend requirements and I'll provide a detailed technical proposal.\n\nBest regards"},{id:"4",title:"Shopify Developer",keywords:"shopify,ecommerce,store,theme,app,liquid",text:"Hello!\nI'm a Shopify expert with extensive experience in developing and customizing Shopify stores. I specialize in theme development, custom app creation, store setup, and optimization.\n\nI can help you with:\n- Custom Shopify theme development\n- Store setup and configuration\n- App development and integration\n- Performance optimization\n- Liquid template customization\n- Payment and shipping setup\n\nI'm familiar with Shopify's ecosystem and can help you create a successful online store. Let's discuss your project!\n\nThanks!"},{id:"5",title:"Full Stack Developer",keywords:"fullstack,mern,mean,full stack,full-stack",text:"Hi there!\nI'm a full stack developer with expertise in both frontend and backend development. I work with modern tech stacks like MERN (MongoDB, Express, React, Node.js), MEAN, and other popular frameworks.\n\nI can handle everything from database design to frontend UI, API development, and deployment. This means you'll have a single developer who can manage your entire project from start to finish.\n\nLet's discuss your project requirements and I'll provide a comprehensive solution that covers all aspects of your application.\n\nLooking forward to working with you!"},{id:"6",title:"Default Template",keywords:"default,general,standard",text:"Hi there!\nI've reviewed your project requirements and I'm confident I can deliver excellent results. With my experience in this field, I can help you achieve your goals efficiently and effectively.\n\nI'm available to start immediately and can work within your timeline. Let's discuss the details and I'll provide a comprehensive solution tailored to your needs.\n\nLooking forward to working with you!"}]}),e.log("Default template initialized with sample templates"));const i=await t.get("customai");null==i&&(await t.set("customai",{enabled:!1,provider:"openai",model:"gpt-4o-mini",maxTokenCount:1e3,useGithubUrl:!1,githubUrl:"",usePortfolioUrl:!1,portfolioUrl:"",useProjectLinks:!1,systemPrompt:"You are an expert freelance bid writer. Write compelling, professional bids that highlight the freelancer's relevant experience and skills. Keep bids concise (2-3 paragraphs), personalized, and focused on how the freelancer can solve the client's problem.",projectLinks:[]}),e.log("Default custom AI settings initialized"));const o=await t.get("telegram");null==o&&(await t.set("telegram",{enabled:!1,botToken:"",chatId:""}),e.log("Default Telegram settings initialized"));const s=await t.get("logs");null==s&&(await t.set("logs",{logs:[],unreadCount:0}),e.log("Default logs initialized"));const l=await t.get("bidding");null==l&&(await t.set("bidding",{isRunning:!1,queue:[],sessionBids:0,lastBidTime:null}),e.log("Default bidding state initialized"));const c=await t.get("chat");null==c&&(await t.set("chat",{threads:[]}),e.log("Default chat initialized")),await t.set("_initialized",!0),e.success("All default values initialized successfully",!0)}catch(r){e.error(`Error initializing defaults: ${r.message}`,!0)}}chrome.runtime.onMessage.addListener((t,r,n)=>{const a={log:$,googleSignIn:S,startBot:P,stopBot:k,validateProject:A,placeBid:C}[t.action];if(a){"log"!==t.action&&e.log(`Message received: ${t.action}`).catch(()=>{});const i=a(t,r,n);return void 0===i||i}return!0}),e.log("Service worker loaded"),I(),"undefined"!=typeof chrome&&chrome.runtime?(chrome.runtime.onInstalled.addListener(async t=>{e.log(`Extension installed/updated: ${t.reason}`),"install"===t.reason&&await I()}),chrome.runtime.onStartup.addListener(()=>{e.log("Browser startup detected"),I()})):e.error("Chrome runtime not available!");
